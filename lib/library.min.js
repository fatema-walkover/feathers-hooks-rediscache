!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("library",[],t):"object"==typeof exports?exports.library=t():e.library=t()}(global,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=11)}([function(e,t){e.exports=require("qs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parsePath=function(e,t={removePathFromCacheKey:!1,parseNestedRoutes:!1}){const r=e.params.query||{},n=t.removePathFromCacheKey,s=t.parseNestedRoutes;let o=n&&e.id?"":`${e.path}`;!n&&s&&(o=function(e,t){const r=new RegExp(":([^\\/\\?]+)\\??","g");let n=null;for(;null!==(n=r.exec(e));)Object.keys(t.route).includes(n[1])&&(e=e.replace(n[0],t.route[n[1]]));return e}(o,e.params));e.id?(0===o.length||n||(o+="/"),Object.keys(r).length>0?o+=`${e.id}?${a.default.stringify(r,{encode:!1})}`:o+=`${e.id}`):Object.keys(r).length>0&&(o+=`?${a.default.stringify(r,{encode:!1})}`);return o};var n,a=(n=r(0))&&n.__esModule?n:{default:n}},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("moment")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.before=function(e){return function(t){const r=t.app.get("redisCache");return e=Object.assign({},u,r,e),new Promise(r=>{const o=t.app.get("redisClient");let u=(0,s.parsePath)(t,e);!0===e.cacheUserWise&&t.params.user&&(t.params.cacheUserWise=e.cacheUserWise,u=t.params.user.id+"#"+u),o.get(u,(s,o)=>{if(null!==s&&r(t),o){let s=JSON.parse(o);const c=(0,n.default)(s.cache.expiresOn).format("DD MMMM YYYY - HH:mm:ss");t.result=s,r(t),"test"!==e.env&&(console.log(`${a.default.cyan("[redis]")} returning cached value for ${a.default.green(u)}.`),console.log(`> Expires on ${c}.`))}else!0===e.immediateCacheKey&&(t.params.cacheKey=u),r(t)})})}},t.after=function(e){return function(t){const r=t.app.get("redisCache");return e=Object.assign({},u,r,e),new Promise(r=>{if(!t.result.cache.cached){const r=t.result.cache.duration||e.defaultDuration,o=t.app.get("redisClient");let u=t.params.cacheKey||(0,s.parsePath)(t,e);!0===t.params.cacheUserWise&&t.params.user&&(u=t.params.user.id+"#"+u),Object.assign(t.result.cache,{cached:!0,duration:r,expiresOn:(0,n.default)().add(n.default.duration(r,"seconds")),parent:t.path,group:t.path?`group-${t.path}`:"",key:u}),o.set(u,JSON.stringify(t.result)),o.expire(u,t.result.cache.duration),t.path&&o.rpush(t.result.cache.group,u),"test"!==e.env&&(console.log(`${a.default.cyan("[redis]")} added ${a.default.green(u)} to the cache.`),console.log(`> Expires in ${n.default.duration(r,"seconds").humanize()}.`))}if(t.result.cache.hasOwnProperty("wrapped")){const{wrapped:e}=t.result.cache;t.result=e}r(t)})}};var n=o(r(3)),a=o(r(2)),s=r(1);function o(e){return e&&e.__esModule?e:{default:e}}const u={env:"production",defaultDuration:86400,immediateCacheKey:!1}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cache=function(e){return function(t){const r=t.app.get("redisCache");if(e=Object.assign({},n,r,e),!t.result.hasOwnProperty("cache")){let r={};if(Array.isArray(t.result)){const e=t.result;r.wrapped=e,t.result={}}r=Object.assign({},r,{cached:!1,duration:e.duration||e.defaultDuration}),t.result.cache=r}return Promise.resolve(t)}},t.removeCacheInformation=function(e){return function(e){return e.result.hasOwnProperty("cache")&&delete e.result.cache,Promise.resolve(e)}};const n={defaultDuration:86400}},function(e,t){e.exports=require("redis")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){return this.set("redisClient",a.default.createClient(this.get("redis"))),this};var n,a=(n=r(6))&&n.__esModule?n:{default:n};e.exports=t.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;t.default=class{constructor(e){this.client=e}clearSingle(e){return new Promise((t,r)=>{this.client.del(`${e}`,(e,n)=>{e&&r(!1),1===n&&t(!0),t(!1)})})}clearGroup(e){return new Promise((t,r)=>{this.client.lrange(e,0,-1,(n,a)=>{n&&r(n),this.clearAll(a).then(this.client.del(e,(e,r)=>{t(1===r)}))})})}clearAll(e){return new Promise(t=>{e.length||t(!1);let r=0;for(;r<e.length;r++)this.clearSingle(e[r]).then(n=>{r===e.length-1&&t(n)})})}},e.exports=t.default},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=s(r(9)),a=s(r(8));function s(e){return e&&e.__esModule?e:{default:e}}const o=200,u=204,c=500;var i=function(e){const t=n.default.Router(),r=e.get("redisClient"),s=new a.default(r);return t.get("/clear",(e,t)=>{r.flushall(),t.status(o).json({message:"Cache cleared",status:o})}),t.get("/clear/single/:target",(e,t)=>{let n=decodeURIComponent(e.params.target);const a=e.query,i=a&&0!==Object.keys(a).length;n&&(i&&(n=decodeURIComponent(e.url.split("/")[3])),r.get(`${n}`,(e,r)=>{e?t.status(c).json({message:"something went wrong"+e.message}):r?s.clearSingle(n).then(e=>{t.status(o).json({message:`cache cleared for key (${i?"with":"without"} params): ${n}`,status:o})}):t.status(o).json({message:`cache already cleared for key (${i?"with":"without"} params): ${n}`,status:u})}))}),t.get("/clear/group/:target",(e,t)=>{let n=decodeURIComponent(e.params.target);n&&(n="group-"+n,r.lrange(n,0,-1,(r,a)=>{r?t.status(c).json({message:"something went wrong"+r.message}):a&&Array.isArray(a)&&a.length>0?s.clearGroup(n).then(r=>{t.status(o).json({message:`cache cleared for the group key: ${decodeURIComponent(e.params.target)}`,status:o})}):t.status(o).json({message:`cache already cleared for the group key: ${decodeURIComponent(e.params.target)}`,status:u})}))}),t};t.default=i,e.exports=t.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=u(r(10)),a=u(r(7)),s=r(5),o=r(4);function u(e){return e&&e.__esModule?e:{default:e}}var c={redisClient:a.default,cacheRoutes:n.default,hookCache:s.cache,hookRemoveCacheInformation:s.removeCacheInformation,redisBeforeHook:o.before,redisAfterHook:o.after};t.default=c,e.exports=t.default}])});
//# sourceMappingURL=library.min.js.map